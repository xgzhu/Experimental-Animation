<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>Chase My Mouse</title>
		<script type="text/javascript">
			var canvas = null;
			var context = null;
			var bufferCanvas = null;
			var bufferCanvasCtx = null;
			var mousePos = null;
			var animateTimer = null;
			var posX = 0;
			var posY = 0;
			var speed = 1.0;
			var info = null;
			var debug = null;
			var mouseImg = null;
			var mouseSize = 40;
			var speedX = 0;
			var speedY = 0;
			var speedAngle = 0;
			var inertia = 0.4;
			var state = 0;	// 0: chase the mouse; 1: try to stop; 2: static state
			
			function init() {
				info = document.getElementById('info');
				debug = document.getElementById('debug');

				mouseImg = document.getElementById("mouseImg");

				canvas = document.getElementById('shownCanvas');
				context = canvas.getContext("2d");
				bufferCanvas = document.createElement("canvas");
				bufferCanvasCtx = bufferCanvas.getContext("2d");
				bufferCanvasCtx.canvas.width = context.canvas.width;
				bufferCanvasCtx.canvas.height = context.canvas.height;
				blank(1);
				context.drawImage(bufferCanvas, 0,0,bufferCanvas.width, bufferCanvas.height);

				canvas.addEventListener('mousemove', function(evt) {
					mousePos = getMousePos(canvas, evt);
					state = 1;
					if (animateTimer == null) {
						posX = mousePos.x;
						posY = mousePos.y;
						animateTimer = setInterval(animate, 25);
					}
				}, false);
			}

			function getMousePos(canvas, evt) {
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
			}

			function blank(a) {
				// bufferCanvasCtx.fillStyle = "#330033";
				bufferCanvasCtx.fillStyle = "rgba(100, 0, 100, " + a + ")";
				bufferCanvasCtx.fillRect(0,0,bufferCanvasCtx.canvas.width, bufferCanvasCtx.canvas.height);
			}

			function animate() {
				if (Update()) Draw();
				// Update();
				// Draw();
				info.innerHTML= posX + ", " +  posY + "->" + mousePos.x + ", " +  mousePos.y;
			}

			function Update() {
				var numeratorX = abs(posX - mousePos.x);
				var numeratorY = abs(posY - mousePos.y);
				var dominator = numeratorX + numeratorY;
				
				if (dominator < 10 && state == 1) {
					state = 2;
				}
				
				if (state == 1) {
					UpdateMoving(numeratorX, numeratorY, dominator);
					debug.innerHTML = "Moving";
					return true;
				}
				else if (state == 2) {
					UpdateStopping();
					debug.innerHTML = "Stopping";
					return true;
				}
				else if (state >= 3 && state < 20) {
					state = state + 1;
					debug.innerHTML = "Stopped";
					return true;
				}
				state = 0;
				return false;
			}

			function UpdateMoving(numeratorX, numeratorY, dominator) {
				if (speed < 32) speed += 1;
				if (dominator < 300) speed = speed / 1.2 + 1;

				speed = Math.round(speed);

				speedX = inertia * speedX + (1 - inertia) * sign(mousePos.x - posX) * min(speed * numeratorX / dominator, numeratorX);
				speedY = inertia * speedY + (1 - inertia) * sign(mousePos.y - posY) * min(speed * numeratorY / dominator, numeratorY);
				posX += Math.round(speedX);
				posY += Math.round(speedY);

				var numeratorX = speedX;
				var numeratorY = speedY;
				var dominator = Math.sqrt(numeratorX * numeratorX + numeratorY * numeratorY);
				var angle = Math.acos(numeratorY/dominator);
				if (numeratorX > 0) angle = Math.PI * 2 - angle;
				speedAngle = inertia * speedAngle + (1 - inertia) * angle;
			}

			function UpdateStopping() {
				
			}

			function Draw(){
				bufferCanvasCtx.save();
				blank(0.7);

				// debug.innerHTML = "Go at speed (" + speedX +", " + speedY + "), with angle " + speedAngle + " " + state;

				bufferCanvasCtx.translate(posX, posY);
				bufferCanvasCtx.rotate(speedAngle);
				bufferCanvasCtx.drawImage(mouseImg, - mouseSize / 2, - mouseSize / 2, mouseSize, mouseSize);

				context.drawImage(bufferCanvas, 0,0,bufferCanvas.width, bufferCanvas.height);

				bufferCanvasCtx.restore();
			}

			function abs(a) {
				if (a > 0) return a;
				return -a;
			}

			function sign(a) {
				if (a > 0) return 1;
				return -1;
			}

			function min(a, b) {
				if (a > b) return b;
				return a;
			}
		</script>
	</head>
	<body onload="init()">
		<canvas id="shownCanvas" width="1800" height="900">
			Canvas not supported
		</canvas>
		<p id="info">info</p>
		<p id="debug">debug</p>
		<img id="mouseImg" src="mouse-test.png" width="20" height="20" style="display:none;">
	</body>
</html>
